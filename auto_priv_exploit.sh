#/bin/bash

usage(){
	echo "[*] Usage: $0 VERSION_OF_KERNEL";
    echo "[*] Example: root~> $0 2.6";
	exit 1;
}

download(){
	base="`find / -name searchsploit -type f | sed 's/searchsploit/platforms/g'`/linux/local"
	echo "[*] The base directory is $base"

	[ -d "${PWD}/${dir_work}" ] || mkdir ${dir_work} # make directory if not exist

	for file in ${file_list}; do
	# TODO get rid of the first . if exist in file path
	# TODO if not exist then do the way it did
	echo "[*] Copying ${base}/${file} ${PWD}/${dir_work}/$file"
	cp ${base}/${file} ${PWD}/${dir_work}/ # copy the file from exploitdb to the current directory with ${dir_work}

	file_extension=$(echo $file | cut -d '.' -f 2) # extract the file extension

		# Count the file for summary
		case $file_extension in
			"c" ) c_file_count=$((c_file_count+1));;
			"rb" ) rb_file_count=$((rb_file_count+1));;
			"txt" ) txt_file_count=$((txt_file_count+1));;
			"py" ) py_file_count=$((py_file_count+1));;
			"pl" ) pl_file_count=$((pl_file_count+1));;
		esac
	done
}

compile(){
	gcc_install=`type gcc 1>> /dev/null 2>&1 ; echo $?`
	if [ ${gcc_install} -eq 0 ]
	then
		for file in $file_list; do
			file_extension=$(echo $file | cut -d '.' -f 2) # extract the file extension
			file_name=$(echo $file | cut -d '/' -f 4) #extrac the file name
			if [ "$file_extension" == "c" ]; then
				gcc ${PWD}/${dir_work}/$file_name -o ${PWD}/${dir_work}/"$file_name.exe" 2>/dev/null
			fi
		done
	else
		echo "ERROR: GCC is not installed"
	fi
}


os_version=$1
os_type="Linux"
dir_work="${os_type}_${os_version}"

file_list=$(searchsploit $os_version ${os_type} | grep local | grep -i privilege | cut -d '|' -f 2 | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' | grep -i "${os_type}" | cut -f4 -d"/")

py_file_count=0
txt_file_count=0
rb_file_count=0
c_file_count=0
pl_file_count=0

main(){
	echo -e "[*] Possible Exploit\n"
    searchsploit $os_version ${os_type} | grep local | grep -i privilege
    if [ -z "`echo $file_list | wc -l`" ]; then
        echo "No possible exploit. Please use another version."
        exit 1
    fi

	echo "[*] Do you wish to download all the exploit script to current directory and compile if possible?"
	select yn in "Yes" "No"; do
		case $yn in
			Yes ) download;break;;
			No ) exit 1;;
		esac
	done
	echo "[*] Do you wish to compile all the exploit script written in C?"
	select yn in "Yes" "No"; do
		case $yn in
			Yes ) compile;break;;
			No ) break;;
		esac
	done
	exe_file_count=$(ls ${PWD}/${dir_work} | grep .exe -c)

	echo "[*] Do you want to make a tar ball of the ${dir_work}? (For convinient file transfer)"
	select yn in "Yes" "No"; do
		case $yn in
			Yes ) cd ${PWD}; tar -cf ${dir_work}.tar ${dir_work};break;;
			No ) break;;
		esac
	done

	echo "[*] Auto Privilege Exploit Summary"
	echo "C file in $PWD/${dir_work} has $c_file_count files"
	echo "Python file in $PWD/${dir_work} has $py_file_count files"
	echo "Perl file in $PWD/${dir_work} has $pl_file_count files"
	echo "Ruby file in $PWD/${dir_work} has $rb_file_count files"
	echo "TXT file in $PWD/${dir_work} has $txt_file_count files"
    echo ""
	echo "[*] Successfully Compiled $exe_file_count executable located in ${dir_work}"
	
}


if [ $# -ne 1 ]
then
	usage
fi

main
